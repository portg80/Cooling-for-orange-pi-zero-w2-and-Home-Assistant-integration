# Охлаждение для orange pi zero w2 + Home Assistant интеграция

!!!В ПРОЦЕССЕ НАПИСАНИЯ!!!

Это проект включает в себя инструкцию как самому **сделать для orange pi zero w2 активное охлаждение кулером** (вентилятором) **с управлением скоростью вращения**. 

Также через MQTT мы будем отображать показатели системы охлаждения прямо в Home Assistant (далее иногда буду называть его "HA") и из него же сможем менять ее настройки.

Сделаем на **Node-Red систему оповещения о критических ситуациях** (если вентилятор помрет и перестанет крутится мы сразу об этом узнаем) уведомлением на телефон, и даже **озвучим экстренное сообщение через Яндекс Алису**!

Написано так, чтобы даже новичок разобрался. 

Я буду иногда расшифровывать сокращения по типу "ШИМ" вот так в скобках: "ШИМ (PWM) («мощности»)" для большей ясности.

## Вот что мы получим в конце:
<img width="2560" height="1280" alt="image" src="https://github.com/user-attachments/assets/8251fcb3-5214-4ed4-8772-b2786988df85" />
Это сама панель управления внутри Home Assistant (HA). 


На графиках отображаются:
- **Температура процессора** (CPU) (получаем через MQTT)
- **Частота ШИМ** (значение от 0 до 1024, чем больше - тем быстрее крутится вентилятор, другими словами "мощность") (получаем через MQTT)
- **Скорость вращения вентилятора** RPS (обороты кулера в секунду) (получаем через MQTT)
- **CPU использование**, нагрузка на процессор в процентах (стандартный датчик HA)

Слайдеры меняют настройки работы системы:
- **Пороги температур:** 

    **Первый слайдер «Temp для 100% вращения»** устанавливает значение температуры процессора, при котором PWM (ШИМ), то есть «мощность» вентилятора, будет максимальной.    
    
    **Второй слайдер "Temp для 0% вращения"** устанавливает ту температуру, при которой вентилятор будет работать на минимальной «мощности», а когда температура опустится ниже, то вовсе отключится

- **Пороги ШИМ** (PWM) («мощности») как раз таки устанавливают минимальный и максимальный порог мощности работы вентилятора. Почему минимальный у меня = 950 PWM? Подобрал это опытным путем, ибо при меньших значениях МОЙ вентилятор за 60р просто не может стартануть.

https://github.com/user-attachments/assets/947b8b01-0ef1-4230-bbaa-66d4df62416a

# Как это выглядит в жизни
<img width="2131" height="787" alt="image" src="https://github.com/user-attachments/assets/45c71ee4-ca26-4b38-b247-b20534737212"/>
<img width="1414" height="766" alt="image" src="https://github.com/user-attachments/assets/939fc397-2d03-4cc7-bb22-bd8d59c58f3f"/>
<img width="957" height="1602" alt="image" src="https://github.com/user-attachments/assets/1341169d-4998-46e3-b951-b53c131e9d5a"/>
Плата:
<img width="1042" height="786" alt="image" src="https://github.com/user-attachments/assets/fc202f43-46d7-44d2-b2c8-30a20651d062"/>
Считаю что моя идеальная пайка заслуживает того чтобы вы **поставили звезду этому репозиторию OwO.** (я просто перепаивал по 10 раз, поэтому так страшно, но работает безотказно)

# Принцип работы
Сразу скажу, на картинке 3 orange pi, но по факту ЭТО ОДИН И ТОТ ЖЕ модуль, просто я разбил на компоненты для наглядности.
Мой Python скрипт птсылает данные в плагин MQTT, а из плагина MQTT они становятся объектами в HA откуда их читает потом моя автоматизация в плагине Node-Red для уведомлений о поломке вентилятора.

Изменение настроек работает примерно по такому же принципу, но в обратную сторону.
<img width="1018" height="764" alt="image" src="https://github.com/user-attachments/assets/bfaffe23-870e-411a-96d9-f422e8b1e9d8" />


# Что купить?
**Цены в российских рублях, актуальные на 14.11.2025**

1 шт. - [MF-25 (С2-23) 0.25Вт, 10 кОм, 1%, Резистор металлопленочный
](https://www.chipdip.ru/product/mf-25-s2-23-0.25vt-10-kom-1-rezistor-metalloplenochnyy-41486) (5 руб)

1 шт. - [CF-25 (С1-4) 0.25Вт, 1 кОм, 5%, Резистор углеродистый](https://www.chipdip.ru/product/cf-25-s1-4-0.25vt-1-kom-5-rezistor-uglerodistyy-44435) (3.80 руб)

1 шт. - [MO-50 (С2-23) 0.5Вт, 470 Ом, 5%, Резистор металлооксидный](https://www.chipdip.ru/product/mo-50-s2-23-0.5vt-470-om-5-rezistor-metallooksidnyy-9000040045) (3.80 руб)

1 шт. - [1N4001, Диод выпрямительный 1А 50В [DO-41 / DO-204AC.]](https://www.chipdip.ru/product/1n4001-diod-vypryamitelnyy-1a-50v-do-41-do-204ac-diotec-9000461658) (5.70 руб)

1 шт. - [IRLZ44NPBF, Транзистор, N-канал 55В 47А logic [TO-220AB]](https://www.chipdip.ru/product/irlz44npbf-tranzistor-n-kanal-55v-47a-logic-to-220ab-infineon-38440) (84.50 руб)

1 шт. - [Макетная плата 4х6 см](https://www.chipdip.ru/product/maketnaya-plata-4x6-sm-8044995884) (32.50 руб)

1 шт. - [Флюс для пайки, паста паяльная канифольно-вазелиновая, 20 г, банка, инд. упаковка, серия "Алмаз" TDM](https://www.chipdip.ru/product/sq1025-1511-flyus-dlya-payki-pasta-payalnaya-tdm-electric-8028919866) (58.50 руб)

1 шт. - [Припой трубка с канифолью, 10 г, 0,8 мм, ПОС-61, колба](https://www.chipdip.ru/product/pripoy-trubka-s-kanifolyu-10-g-0-8-mm-pos-61-kolba-9001150465) (100 руб)

1 шт. - [EX295193RUS, Вентилятор 5В DC ExeGate EX04010S3P-5 (40x40x10 мм, Sleeve bearing (подшипник скольжения), 3pin, 5000RPM, 24dBA)](https://www.chipdip.ru/product/ex295193rus-ventilyator-5v-dc-exegate-ex04010s3p-5-8038575118) (62 руб)

4 шт. используется в проекте, но брал набор из 40 - [Соединительные провода «папа-мама» (40 шт. / 20 см), Шлейф из 40 проводов для прототипирования электронных устройств
](https://www.chipdip.ru/product/soedinitelnye-provoda-papa-mama-40-sht-20-sm-shleyf-iz-9001322248) (200 руб)

2 шт. используется в проекте, но брал набор из 5 - [JST PH 2.0мм 4pin кабель с разъемом](https://www.ozon.ru/product/kabel-dlya-podklyucheniya-periferiynyh-ustroystv-0-15-m-krasnyy-chernyy-2368560758/?at=Brtz2BAv9IApANKMigDmRj6uvKN3zQF0JA1j2ur9noMW) (~150р)

ИТОГО: ~705 рублей с набором проводов и коннекторами, без них цена ~350 руб, можно сэкономить на наборах поменьше или найти поштучно.

# Схема пайки и подключения
**Страшная принципиальная:**
<img width="1315" height="799" alt="image" src="https://github.com/user-attachments/assets/dbce08c2-b91f-4f59-b46a-b8aab996bda9" />

**Вот схема подключения с подписями каждого пина (контакта):**
<img width="1317" height="602" alt="image" src="https://github.com/user-attachments/assets/9a6d0b24-5847-4819-ad20-98152d53234a" />
GND можно воткнуть в любой свободный, а PWM read и PWM control переназначить в моем скрипте (PWM control только на пин с поддержкой ШИМ, по типу PWM1 PWM2 на картинке).


# Устанавливаем и настраиваем Python скрипт 
Скрипт находится в файле **pwm_fan_daemon.py**, можете открыть его где вам удобно в текстовом редакторе и поменять нужные настройки. 

## настроим MQTT на Home Assistant
**Создадим отдельного пользователя именно для mqtt.**
**В Home Assistant:**
 
**Настройки -> Люди -> Пользователи -> Добавить пользователя (галочка администратора НЕ нужна) -> задаем имя и пароль и нажимаем добавить**


**В Home Assistant:**
**Настройки -> Дополнения -> Магазин дополнений -> в поиске ищем "Mosquitto broker" и устанавливаем -> открываем его и вверху вкладка конфигурация есть, переходим на нее -> в категории Logins нажимаем кнопку "Добавить" -> вписываем логин и пароль пользователя созданного на предыдущем шаге**

Выглядеть все должно примерно так:
<img width="1321" height="907" alt="image" src="https://github.com/user-attachments/assets/0f0b605a-728f-4270-959b-f79bcffbc58d" />
<img width="1314" height="279" alt="image" src="https://github.com/user-attachments/assets/8dd52c81-65ca-4d23-8612-4aab6ca93e5e" />


## какие настройки нужно изменить:

 Читайте текст после символа решетки (#), там описано что за что отвечает. Обратите внимание, что значения в итоге **должны быть в кавычках!** 
 
 Например 
 ```
 MQTT_BROKER = "ВАШ_АДРЕС_HOME_ASSISTANT"
```
 вы измените на 
```
 MQTT_BROKER = "192.168.1.21"
```
Менять нужно эти настройки (ищите через поиск по файлу названия переменных по типу MQTT_USER, TEMP_CHECK_INTERVAL и остальные, и меняем значения после равно):
```
...
TEMP_CHECK_INTERVAL = 8 # Время интервала сканирования температуры в секундах и отправки данных на сервер MQTT в секундах. Например тут через каждые 8 секунд.
...
# MQTT-настройки
MQTT_BROKER = "ВАШ_АДРЕС_HOME_ASSISTANT"  # тут ваш адрес Home Assistant, без порта! Например: MQTT_BROKER = "192.168.1.21"
MQTT_PORT = 1883   # это стандартный прорт MQTT. Можно поменять в настройках плагина MQTT если хотите а потом и тут, я не менял.
MQTT_USER = "ВАШ_USER_NAME_СОЗДАННОГО_ПОЛЬЗОВАТЕЛЯ" # имя пользователя для входа. Например: MQTT_USER = "mqtt-user"
MQTT_PASSWORD = "ВАШ_ПАРОЛЬ_СОЗДАННОГО_ПОЛЬЗОВАТЕЛЯ" # ваш пароль для входа в созданного пользователя. Например: MQTT_PASSWORD = "hhe7f2@HD$@#5D!fe2"
...
```
